@using DomraSinForms.Application.Forms.Queries.GetList;
@using Microsoft.AspNetCore.Mvc.Localization;
@model FormListDto
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Forms"];
    var searchText = Model.Query.SearchText;
    var order = Model.Query.OrderBy;

    string LastEditFormat(DateTime lastEditDate)
    {
        if (lastEditDate == DateTime.MinValue)
        {
            return "-";
        }
        else if (lastEditDate.Date == DateTime.Today.Date)
        {
            return lastEditDate.ToLocalTime().ToShortTimeString();
        }
        else
        {
            return lastEditDate.ToLocalTime().ToShortDateString();
        }
    }

    var orderApproaches = new[]
    {
        new SelectListItem(Localizer["By title"]?.Value, ((int)FormOrderApproach.Title).ToString()),
        new SelectListItem(Localizer["By title descending"]?.Value, ((int)FormOrderApproach.TitleDescending).ToString()),
        new SelectListItem(Localizer["By creation date"]?.Value, ((int)FormOrderApproach.Creation).ToString()),
        new SelectListItem(Localizer["By creation date descending"]?.Value, ((int)FormOrderApproach.CreationDescending).ToString()),
        new SelectListItem(Localizer["By last edit date"]?.Value, ((int)FormOrderApproach.LastUpdate).ToString()),
        new SelectListItem(Localizer["By last edit date descending"]?.Value, ((int)FormOrderApproach.LastUpdateDescending).ToString()),
    };

}
<div class="row g-3 justify-content-between">

    <div class="col-12 text-center display-5 mb-5">@Localizer["Forms"]</div>


    <div class="col-12 col-sm-4 text-sm-start text-center">
        <a class="btn btn-primary form-control" asp-action="Create"><i class="bi-plus-circle me-2"></i> @Localizer["New form"]</a>
    </div>

    

    <div class="col-12 col-sm-4">
        <form asp-controller="Forms" asp-action="Index" asp-route-page="@searchText">
            <div class="input-group">
                <input asp-for="@searchText" type="text" class="form-control" placeholder="@Localizer["Search ..."]" aria-label="Input group example" aria-describedby="btnGroupAddon">
                <button class="btn btn-outline-secondary input-group-text" id="btnGroupAddon" type="submit"><i class="bi-search"></i></button>
            </div>
        </form>
    </div>
    <div class="col-12 col-sm-4">
        <form asp-controller="Forms" asp-action="Index" asp-route-order="@order">
            <div class="input-group">
                <select asp-for="@order" class="form-select" asp-items="@(orderApproaches)"></select>
                @*<input asp-for="@searchText" type="text" class="form-control" placeholder="@Localizer["Search ..."]" aria-label="Input group example" aria-describedby="btnGroupAddon">*@
                <button class="btn btn-outline-secondary input-group-text" id="btnGroupAddon" type="submit"><i class="bi-search"></i></button>
            </div>
        </form>
        

    </div>
    @foreach (var form in Model.Forms)
    {
        <div class="col-12 col-md-6">
            <div class="card" asp-action="Edit" asp-route-id="@form.Id">
                <a class="card-body text-decoration-none" asp-action="Edit" asp-route-id="@form.Id">
                    <div class="card-title h5">@form.Title</div>
                    <div class="card-text mb-2">@form.Description</div>
                    <div class="card-text text-muted">@Localizer["Last edit"]: @LastEditFormat(form.LastUpdateDate)</div>
                </a>
                <div class="card-footer">
                    <div class="row g-1">
                        <div class="col-6 col-md-3">
                            <a class="btn btn-sm btn-outline-secondary form-control" asp-action="Edit" asp-route-id="@form.Id">@Localizer["Edit"]</a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a class="btn btn-sm btn-outline-primary form-control" asp-controller="Answers" asp-action="Fill" asp-route-formId="@form.Id">@Localizer["Fill"]</a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a class="btn btn-sm btn-outline-info form-control" data-bs-toggle="modal" data-bs-target="#share@(form.Id)">@Localizer["Share"]</a>
                            @await Html.PartialAsync("_ShareModalPartial", form.Id, new ViewDataDictionary(ViewData){{"ModalId", $"share{form.Id}"}})
                        </div>
                        <div class="col-6 col-md-3">
                            <a class="btn btn-sm btn-outline-danger form-control" data-bs-toggle="modal" data-bs-target="#delete@(form.Id)">@Localizer["Delete"]</a>
                            @await Html.PartialAsync("_DeleteModalPartial", form, new ViewDataDictionary(ViewData){{"ModalId", $"delete{form.Id}"}})
                        </div>
                    </div>
                </div>
            </div>

        </div>
    }
    <div class="col-12 justify-content-center btn-toolbar" role="toolbar" aria-label="Toolbar with button groups" @(Model.PageCount == 1 ? "hidden" : "")>
        <div class="btn-group me-2" role="group" aria-label="First group">
            @for (int i = 0; i < Model.PageCount; i++)
            {
                <a asp-controller="Forms"
               asp-action="Index"
               asp-route-page="@i"
               asp-route-count="@Model.Query.Count"
               asp-route-order="@Model.Query.OrderBy"
                   class="btn @((i) == Model.Query.Page ? "btn-secondary" : "btn-outline-secondary")"
                   type="button"> @(i + 1)</a>
            }
        </div>
    </div>
    @*<table class="col-11 table">
        <thead>
            <tr>
                <th>
                    @Localizer["Title"]
                <th>
                    @Localizer["Description"]
                </th>
                <th>
                    @Localizer["Creation date"]
                </th>
                <th>
                    @Localizer["Last edit"]
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var form in Model.Forms)
            {
                <tr>
                    <td>
                        @form.Title
                    </td>
                    <td>
                        @form.Description
                    </td>
                    <td>
                        @form.CreationDate.ToShortDateString()
                    </td>
                    <td>
                        @if(form.LastUpdateDate == DateTime.MinValue) 
                        {

                        }
                        else if(form.LastUpdateDate.Date == DateTime.Today.Date)
                        {
                            @form.LastUpdateDate.ToLocalTime().ToShortTimeString()   
                        }
                        else
                        {
                            @form.LastUpdateDate.ToLocalTime().ToShortDateString();
                        }
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@form.Id">@Localizer["Edit"]</a> |
                        <a asp-controller="Answers" asp-action="Fill" asp-route-formId="@form.Id">@Localizer["Fill"]</a> |
                        <a class="link-danger"
                           data-bs-toggle="modal"
                           data-bs-target="#deleteModal"
                           data-bs-id="@form.Id"
                           data-bs-title="@form.Title">@Localizer["Delete"]</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>*@



</div>

<div class="row g-3">
    
</div>

@*<div class="modal" id="deleteModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-1 text-center">

            <div class="modal-body justify-content-center">

                <div class="h2 mb-5">@Localizer["Delete form <q></q>?"]</div>

                <form asp-action="Delete" method="post">
                    <input class="btn btn-danger" type="submit" value="@Localizer["Delete"]" />
                </form>

            </div>

        </div>
    </div>
</div>




@section Scripts
    {
    <script>
        const deleteModal = document.getElementById('deleteModal')
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', event => {
                // event sender
                const button = event.relatedTarget
                // attribute extractions
                const id = button.getAttribute('data-bs-id')
                const title = button.getAttribute('data-bs-title')

                // Update the modal's content.
                deleteModal.querySelector('.modal-body form').attributes.getNamedItem("action").value += `/${id}`;
                const titleElement = document.createTextNode(title);
                deleteModal.querySelector('.modal-body div q').appendChild(titleElement); //parentNode.appendChild(`<div>${title}</div>`);
            })
        }
    </script>
}*@